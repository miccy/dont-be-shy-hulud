name: Supply Chain Security Scan

on:
  pull_request:
    branches: [main, master]
  schedule:
    - cron: "0 6 * * *" # Daily at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  shai-hulud-scan:
    name: Shai-Hulud Detection
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          allowed-endpoints: >
            registry.npmjs.org:443
            github.com:443
            api.github.com:443
            raw.githubusercontent.com:443

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Make Shai-Hulud Detector Executable
        run: chmod +x packages/scripts/detect.sh

      - name: Run Shai-Hulud Detector
        id: detect
        run: |
          set -eo pipefail
          # initialize rc so we always have a value
          rc=0
          # run detector and capture exit code (allow failure)
          ./packages/scripts/detect.sh . --ci --output=results.txt || rc=$?

          # Ensure results.txt exists and use an unambiguous marker
          if [ ! -f results.txt ]; then
            echo "NO_FINDINGS" > results.txt
          fi

          # Determine if issues were found: results is non-empty, not the NO_FINDINGS marker, and detector returned non-zero
          if [ -s results.txt ] && ! grep -q '^NO_FINDINGS$' results.txt && [ "${rc}" -ne 0 ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

          echo "exit_code=${rc}" >> $GITHUB_OUTPUT

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shai-hulud-scan-results
          path: |
            results.txt
            shai-hulud-*.log
          retention-days: 30

      - name: Fail on Detection
        if: steps.detect.outputs.found == 'true'
        run: |
          echo "::error::Shai-Hulud IOCs detected! Check artifacts for details."
          echo "Review artifact: shai-hulud-scan-results (results.txt)"
          exit 1

  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          allowed-endpoints: >
            registry.npmjs.org:443
            github.com:443

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Configure npm security
        run: |
          npm config set ignore-scripts true
          npm config set audit true
          npm config set fund false

      - name: Check for lockfile
        id: lockfile
        run: |
          if [[ -f "package-lock.json" ]]; then
            echo "lockfile=npm" >> $GITHUB_OUTPUT
          elif [[ -f "yarn.lock" ]]; then
            echo "lockfile=yarn" >> $GITHUB_OUTPUT
          elif [[ -f "pnpm-lock.yaml" ]]; then
            echo "lockfile=pnpm" >> $GITHUB_OUTPUT
          elif [[ -f "bun.lockb" ]]; then
            echo "lockfile=bun" >> $GITHUB_OUTPUT
          else
            echo "lockfile=none" >> $GITHUB_OUTPUT
          fi

      - name: Install Dependencies (npm - no scripts)
        if: steps.lockfile.outputs.lockfile == 'npm'
        run: npm ci --ignore-scripts

      - name: Lockfile Lint
        if: steps.lockfile.outputs.lockfile == 'npm'
        run: |
          npx lockfile-lint \
            --path package-lock.json \
            --allowed-hosts npm \
            --validate-https \
            --validate-integrity

      - name: npm Audit
        if: steps.lockfile.outputs.lockfile == 'npm'
        run: npm audit --audit-level=high
        continue-on-error: true

  # For Bun projects
  bun-security:
    name: Bun Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for Bun lockfile
        id: bun_check
        run: |
          if [ -f "bun.lockb" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Bun lockfile not found, skipping Bun security scan."
          fi

      - name: Setup Bun
        if: steps.bun_check.outputs.exists == 'true'
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # ⚠️ CRITICAL: .npmrc ignore-scripts does NOT work in Bun!
      # ALWAYS use --ignore-scripts flag
      - name: Install (ALWAYS use --ignore-scripts flag)
        if: steps.bun_check.outputs.exists == 'true'
        run: bun install --ignore-scripts

      - name: Check for trustedDependencies
        if: steps.bun_check.outputs.exists == 'true'
        run: |
          if grep -q "trustedDependencies" package.json 2>/dev/null; then
            echo "::warning::trustedDependencies found in package.json - review carefully"
            grep -A 10 "trustedDependencies" package.json
          fi
